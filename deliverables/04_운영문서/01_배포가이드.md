# 배포 가이드

**프로젝트명**: 푸름대학교 학생성장지원센터 CHAMP (SCMS3)
**작성일**: 2025-11-18
**버전**: 1.0
**작성자**: 개발팀

---

## 1. 문서 개요

### 1.1 목적
본 문서는 SCMS3 시스템의 배포 절차 및 방법을 상세히 기술하여, 개발/스테이징/운영 환경에 시스템을 안전하게 배포할 수 있도록 합니다.

### 1.2 대상 독자
- DevOps 엔지니어
- 시스템 관리자
- 백엔드 개발자

---

## 2. 배포 환경

### 2.1 환경 구성

| 환경 | 용도 | URL | 서버 |
|------|------|-----|------|
| **개발 (Development)** | 개발자 로컬 환경 | http://localhost:8080 | 개발자 PC |
| **스테이징 (Staging)** | 테스트 및 검증 | http://staging.scms.pureum.ac.kr | 스테이징 서버 |
| **운영 (Production)** | 실제 서비스 | https://scms.pureum.ac.kr | 운영 서버 |

### 2.2 시스템 요구사항

#### 2.2.1 하드웨어
- **CPU**: 4 Core 이상
- **RAM**: 8GB 이상
- **Disk**: 50GB 이상 (SSD 권장)

#### 2.2.2 소프트웨어
- **OS**: Ubuntu 20.04 LTS 이상 또는 CentOS 7 이상
- **JDK**: Java 17 LTS
- **Database**: MySQL 8.0
- **웹서버**: Nginx 1.18 이상 (선택사항)
- **Docker**: 20.10 이상 (선택사항)

---

## 3. 사전 준비

### 3.1 JDK 17 설치

#### Ubuntu/Debian
```bash
sudo apt update
sudo apt install openjdk-17-jdk -y

# 확인
java -version
```

#### CentOS/RHEL
```bash
sudo yum install java-17-openjdk java-17-openjdk-devel -y

# 확인
java -version
```

### 3.2 MySQL 8.0 설치

#### Ubuntu/Debian
```bash
# MySQL APT Repository 추가
wget https://dev.mysql.com/get/mysql-apt-config_0.8.22-1_all.deb
sudo dpkg -i mysql-apt-config_0.8.22-1_all.deb
sudo apt update

# MySQL 설치
sudo apt install mysql-server -y

# MySQL 시작
sudo systemctl start mysql
sudo systemctl enable mysql

# 보안 설정
sudo mysql_secure_installation
```

#### CentOS/RHEL
```bash
# MySQL Yum Repository 추가
sudo yum install https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm -y

# MySQL 설치
sudo yum install mysql-community-server -y

# MySQL 시작
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 임시 root 비밀번호 확인
sudo grep 'temporary password' /var/log/mysqld.log

# 보안 설정
sudo mysql_secure_installation
```

### 3.3 데이터베이스 생성

```sql
-- MySQL에 root로 로그인
mysql -u root -p

-- 데이터베이스 생성
CREATE DATABASE IF NOT EXISTS scms2
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

-- 사용자 생성 및 권한 부여
CREATE USER 'scms_user'@'localhost' IDENTIFIED BY 'strong_password_here';
GRANT ALL PRIVILEGES ON scms2.* TO 'scms_user'@'localhost';
FLUSH PRIVILEGES;

-- 종료
EXIT;
```

### 3.4 스키마 초기화

```bash
# 스키마 파일 실행
mysql -u scms_user -p scms2 < database/schema.sql
```

---

## 4. 애플리케이션 빌드

### 4.1 소스코드 가져오기

```bash
# Git 저장소 클론
git clone https://github.com/seedevk8s/SCMS3.git
cd SCMS3

# 특정 브랜치 체크아웃 (운영 배포 시)
git checkout main
```

### 4.2 Gradle 빌드

```bash
# 실행 권한 부여
chmod +x gradlew

# 빌드 (테스트 포함)
./gradlew clean build

# 빌드 (테스트 제외)
./gradlew clean build -x test

# JAR 파일 위치
ls -lh build/libs/scms3-*.jar
```

**빌드 산출물**:
- `build/libs/scms3-0.0.1-SNAPSHOT.jar`

---

## 5. 설정 파일 구성

### 5.1 application.yml 설정

운영 환경에 맞게 `application-prod.yml` 파일을 생성합니다.

**파일 위치**: `src/main/resources/application-prod.yml`

```yaml
spring:
  profiles:
    active: prod

  datasource:
    url: jdbc:mysql://localhost:3306/scms2?useSSL=true&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul
    username: scms_user
    password: ${DB_PASSWORD}  # 환경 변수로 주입
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  jpa:
    hibernate:
      ddl-auto: validate  # 운영에서는 validate 사용
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        default_batch_fetch_size: 100

  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB

  security:
    filter:
      order: 10

server:
  port: 8080
  servlet:
    context-path: /
    session:
      timeout: 30m
  compression:
    enabled: true
    mime-types: text/html,text/css,application/javascript,application/json
  error:
    include-stacktrace: never

logging:
  level:
    root: INFO
    com.scms.app: INFO
    org.springframework.web: WARN
    org.hibernate: WARN
  file:
    name: logs/scms3.log
    max-size: 100MB
    max-history: 30
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# 파일 업로드 경로
file:
  upload:
    dir: /var/scms3/uploads

# CORS 설정 (필요 시)
cors:
  allowed-origins:
    - https://scms.pureum.ac.kr
```

### 5.2 환경 변수 설정

민감한 정보는 환경 변수로 관리합니다.

```bash
# /etc/profile.d/scms3.sh 파일 생성
sudo nano /etc/profile.d/scms3.sh

# 내용 입력
export DB_PASSWORD="strong_password_here"
export JWT_SECRET="your_jwt_secret_key_here"
export FILE_UPLOAD_DIR="/var/scms3/uploads"

# 권한 설정
sudo chmod 644 /etc/profile.d/scms3.sh

# 적용
source /etc/profile.d/scms3.sh
```

---

## 6. 배포 방법

### 6.1 수동 배포 (Manual Deployment)

#### 6.1.1 JAR 파일 직접 실행

```bash
# 빌드된 JAR 파일 실행
java -jar build/libs/scms3-0.0.1-SNAPSHOT.jar \
  --spring.profiles.active=prod

# 백그라운드 실행
nohup java -jar build/libs/scms3-0.0.1-SNAPSHOT.jar \
  --spring.profiles.active=prod \
  > /var/log/scms3/app.log 2>&1 &

# PID 확인
echo $! > /var/run/scms3.pid
```

#### 6.1.2 systemd 서비스 등록

더 안정적인 운영을 위해 systemd 서비스로 등록합니다.

**파일 위치**: `/etc/systemd/system/scms3.service`

```ini
[Unit]
Description=SCMS3 Spring Boot Application
After=syslog.target network.target mysql.service

[Service]
User=scms
Group=scms
Type=simple

WorkingDirectory=/opt/scms3
ExecStart=/usr/bin/java \
  -Xms2G \
  -Xmx4G \
  -Dspring.profiles.active=prod \
  -jar /opt/scms3/scms3-0.0.1-SNAPSHOT.jar

StandardOutput=journal
StandardError=journal
SyslogIdentifier=scms3

SuccessExitStatus=143

Restart=on-failure
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**서비스 관리 명령어**:

```bash
# 서비스 등록 및 시작
sudo systemctl daemon-reload
sudo systemctl enable scms3
sudo systemctl start scms3

# 상태 확인
sudo systemctl status scms3

# 로그 확인
sudo journalctl -u scms3 -f

# 재시작
sudo systemctl restart scms3

# 중지
sudo systemctl stop scms3
```

---

### 6.2 Docker 배포

#### 6.2.1 Dockerfile 작성

**파일 위치**: `Dockerfile`

```dockerfile
# Multi-stage build
FROM gradle:8.5-jdk17 AS build
WORKDIR /app
COPY . .
RUN gradle clean build -x test

FROM openjdk:17-jdk-slim
WORKDIR /app

# JAR 파일 복사
COPY --from=build /app/build/libs/scms3-*.jar app.jar

# 업로드 디렉토리 생성
RUN mkdir -p /app/uploads

# 포트 노출
EXPOSE 8080

# 헬스체크
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# 애플리케이션 실행
ENTRYPOINT ["java", "-Dspring.profiles.active=prod", "-jar", "app.jar"]
```

#### 6.2.2 Docker Compose 구성

**파일 위치**: `docker-compose.prod.yml`

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: scms3-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: scms2
      MYSQL_USER: scms_user
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - scms_network
    command: --default-authentication-plugin=mysql_native_password

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: scms3-app
    restart: always
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/scms2?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul
      SPRING_DATASOURCE_USERNAME: scms_user
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
    volumes:
      - app_uploads:/app/uploads
      - app_logs:/app/logs
    networks:
      - scms_network
    depends_on:
      - mysql
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  nginx:
    image: nginx:latest
    container_name: scms3-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    networks:
      - scms_network
    depends_on:
      - app

volumes:
  mysql_data:
  app_uploads:
  app_logs:

networks:
  scms_network:
    driver: bridge
```

#### 6.2.3 Docker 배포 명령어

```bash
# 환경 변수 파일 생성 (.env)
echo "MYSQL_ROOT_PASSWORD=root_password" > .env
echo "DB_PASSWORD=scms_password" >> .env

# Docker Compose 빌드 및 실행
docker-compose -f docker-compose.prod.yml up -d --build

# 로그 확인
docker-compose -f docker-compose.prod.yml logs -f app

# 컨테이너 상태 확인
docker-compose -f docker-compose.prod.yml ps

# 중지
docker-compose -f docker-compose.prod.yml down

# 전체 삭제 (데이터 포함)
docker-compose -f docker-compose.prod.yml down -v
```

---

### 6.3 Nginx 리버스 프록시 설정

#### 6.3.1 Nginx 설정 파일

**파일 위치**: `/etc/nginx/sites-available/scms3`

```nginx
upstream scms3_backend {
    server localhost:8080 fail_timeout=10s max_fails=3;
}

server {
    listen 80;
    server_name scms.pureum.ac.kr;

    # HTTP to HTTPS 리다이렉트
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name scms.pureum.ac.kr;

    # SSL 인증서
    ssl_certificate /etc/nginx/ssl/scms.pureum.ac.kr.crt;
    ssl_certificate_key /etc/nginx/ssl/scms.pureum.ac.kr.key;

    # SSL 설정
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 로그
    access_log /var/log/nginx/scms3_access.log;
    error_log /var/log/nginx/scms3_error.log;

    # 클라이언트 최대 바디 크기
    client_max_body_size 10M;

    # Gzip 압축
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

    # 정적 파일 (선택사항)
    location /static/ {
        alias /opt/scms3/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 업로드 파일
    location /uploads/ {
        alias /var/scms3/uploads/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # 프록시 설정
    location / {
        proxy_pass http://scms3_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # WebSocket 지원 (향후 필요 시)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 헬스 체크 (모니터링용)
    location /actuator/health {
        proxy_pass http://scms3_backend;
        access_log off;
    }
}
```

#### 6.3.2 Nginx 설정 적용

```bash
# 심볼릭 링크 생성
sudo ln -s /etc/nginx/sites-available/scms3 /etc/nginx/sites-enabled/

# 설정 테스트
sudo nginx -t

# Nginx 재시작
sudo systemctl restart nginx

# 상태 확인
sudo systemctl status nginx
```

---

## 7. CI/CD 파이프라인 (GitHub Actions)

### 7.1 GitHub Actions 워크플로우

**파일 위치**: `.github/workflows/deploy.yml`

```yaml
name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Upload JAR to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "build/libs/scms3-*.jar"
          target: "/opt/scms3/"
          strip_components: 2

      - name: Deploy application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo systemctl restart scms3
            sleep 10
            sudo systemctl status scms3
```

### 7.2 GitHub Secrets 설정

GitHub Repository → Settings → Secrets and variables → Actions에서 추가:

- `SERVER_HOST`: 운영 서버 IP 또는 도메인
- `SERVER_USER`: SSH 사용자명
- `SSH_PRIVATE_KEY`: SSH 비밀키

---

## 8. 배포 체크리스트

### 8.1 배포 전 체크리스트

- [ ] 소스코드 최신 버전 확인
- [ ] 데이터베이스 백업 완료
- [ ] 설정 파일 검증 (`application-prod.yml`)
- [ ] 환경 변수 설정 확인
- [ ] 빌드 성공 확인 (`./gradlew clean build`)
- [ ] 테스트 통과 확인
- [ ] 디스크 공간 확인 (`df -h`)
- [ ] 서버 리소스 확인 (`free -h`, `top`)

### 8.2 배포 중 체크리스트

- [ ] 기존 서비스 중지
- [ ] 새 JAR 파일 배포
- [ ] 서비스 시작
- [ ] 헬스 체크 확인 (`curl http://localhost:8080/actuator/health`)
- [ ] 로그 확인 (`tail -f logs/scms3.log`)
- [ ] 주요 기능 동작 확인

### 8.3 배포 후 체크리스트

- [ ] 로그인 기능 테스트
- [ ] 프로그램 목록 조회 테스트
- [ ] 프로그램 신청 테스트
- [ ] 마일리지 조회 테스트
- [ ] 알림 기능 테스트
- [ ] 에러 로그 모니터링
- [ ] 성능 모니터링 (응답 시간, CPU, 메모리)
- [ ] 사용자 피드백 수집

---

## 9. 롤백 절차

배포 후 문제가 발생할 경우 이전 버전으로 롤백합니다.

### 9.1 수동 롤백

```bash
# 1. 서비스 중지
sudo systemctl stop scms3

# 2. 이전 버전 복원
cd /opt/scms3
cp scms3-0.0.1-SNAPSHOT.jar.backup scms3-0.0.1-SNAPSHOT.jar

# 3. 서비스 재시작
sudo systemctl start scms3

# 4. 상태 확인
sudo systemctl status scms3
```

### 9.2 데이터베이스 롤백

```bash
# 백업본 복원
mysql -u scms_user -p scms2 < backup_20251118.sql
```

---

## 10. 모니터링

### 10.1 애플리케이션 로그

```bash
# 실시간 로그
tail -f /var/log/scms3/scms3.log

# 에러 로그만 필터링
tail -f /var/log/scms3/scms3.log | grep ERROR

# 최근 100줄
tail -n 100 /var/log/scms3/scms3.log
```

### 10.2 시스템 리소스

```bash
# CPU, 메모리 사용률
top

# 디스크 사용량
df -h

# 메모리 사용량
free -h

# 프로세스 확인
ps aux | grep java
```

### 10.3 Spring Boot Actuator

```bash
# 헬스 체크
curl http://localhost:8080/actuator/health

# 메트릭 조회
curl http://localhost:8080/actuator/metrics

# 환경 정보
curl http://localhost:8080/actuator/env
```

---

## 11. 트러블슈팅

### 11.1 애플리케이션 시작 실패

**증상**: 서비스가 시작되지 않음

**원인**:
- 포트 8080이 이미 사용 중
- 데이터베이스 연결 실패
- JDK 버전 불일치

**해결**:
```bash
# 포트 사용 확인
sudo lsof -i:8080

# 데이터베이스 연결 확인
mysql -u scms_user -p -h localhost scms2

# Java 버전 확인
java -version
```

### 11.2 데이터베이스 연결 오류

**증상**: `Could not open JDBC Connection`

**원인**:
- MySQL 서비스 미실행
- 잘못된 DB 계정 정보
- 방화벽 차단

**해결**:
```bash
# MySQL 상태 확인
sudo systemctl status mysql

# MySQL 시작
sudo systemctl start mysql

# 방화벽 확인
sudo ufw status
```

### 11.3 메모리 부족 (OutOfMemoryError)

**증상**: `java.lang.OutOfMemoryError: Java heap space`

**원인**: JVM 힙 메모리 부족

**해결**:
```bash
# JVM 옵션 조정 (systemd 서비스 파일)
ExecStart=/usr/bin/java \
  -Xms4G \
  -Xmx8G \
  -jar /opt/scms3/scms3-0.0.1-SNAPSHOT.jar
```

---

## 12. 보안 고려사항

### 12.1 방화벽 설정

```bash
# UFW 방화벽 (Ubuntu)
sudo ufw allow 22/tcp      # SSH
sudo ufw allow 80/tcp      # HTTP
sudo ufw allow 443/tcp     # HTTPS
sudo ufw enable

# 포트 8080은 외부 접근 차단 (Nginx 프록시 사용)
```

### 12.2 SSL/TLS 인증서

```bash
# Let's Encrypt 인증서 발급 (Certbot)
sudo apt install certbot python3-certbot-nginx -y

sudo certbot --nginx -d scms.pureum.ac.kr

# 자동 갱신 확인
sudo certbot renew --dry-run
```

### 12.3 민감 정보 관리

- 환경 변수로 DB 비밀번호, API 키 등 관리
- `.env` 파일을 `.gitignore`에 추가
- 프로덕션 환경에서는 AWS Secrets Manager, HashiCorp Vault 등 사용 권장

---

## 13. 참고 자료

### 13.1 관련 문서
- [시스템 아키텍처 설계서](../02_설계문서/01_시스템아키텍처설계서.md)
- [시스템 운영 매뉴얼](./03_시스템운영매뉴얼.md)

### 13.2 외부 참조
- Spring Boot Documentation: https://spring.io/projects/spring-boot
- Docker Documentation: https://docs.docker.com/
- Nginx Documentation: https://nginx.org/en/docs/

---

## 14. 버전 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2025-11-18 | 개발팀 | 최초 작성 |

---

**문서 작성일**: 2025-11-18
**최종 검토자**: 개발팀
**승인일**: 2025-11-18
